# 函數建構器

## 題目敘述

給定一個使用 lambda 記號法定義的數學函數和一個數值，計算將該函數應用於數值後的結果。Lambda 函數使用 `(\變數.表達式)` 的語法格式，其中表達式可以包含變數、數字、算術運算子以及括號。


## 輸入格式

**格式說明：**
- 第 1 行：查詢數量 N (1 ≤ N ≤ 100)
- 接下來 N 行：每行包含一個 lambda 函數定義和要應用的值，以空格分隔

**Lambda 函數語法：**
- 基本格式：`(\變數名.表達式)` 或 `(\variable.expression)`
- 變數名：以小寫字母開頭，可包含數字 (例如：`x`, `y`, `var1`, `param2`)
- 表達式可包含：
  - **變數**：lambda 參數或其他定義的變數
  - **整數**：0 到 100 之間的正整數
  - **算術運算子**：`+` (加法), `-` (減法), `*` (乘法)
  - **括號**：`()` 用於改變運算優先順序或分組
  - **嵌套結構**：表達式內可包含其他完整的表達式

**運算子優先順序：**
1. `*` (乘法) - 最高優先順序
2. `+`, `-` (加法、減法) - 較低優先順序
3. 同優先順序從左到右計算
4. 括號可改變優先順序

## 輸出格式
對於每個查詢，輸出一行包含將 lambda 函數應用於給定值後的計算結果（整數）。

## 範例輸入
```
6
(\x.x+1) 5
(\x.2*x) 3
(\x.x*x) 4
(\y.(y+1)*2) 3
(\z.z*(z+1)+(z-1)) 4
(\a.(a+2)*(a-1)+a*a) 2
```

## 範例輸出
```
6
6
16
8
23
8
```

## 解釋

**Lambda 函數的工作原理：**
Lambda 函數 `(\變數.表達式)` 定義了一個匿名函數，當應用於某個值時，會將表達式中所有出現的變數替換為該值，然後計算結果。這個過程稱為 **β-約簡 (Beta Reduction)**。

**詳細步驟解析：**

1. `(\x.x+1)` 應用於 5：
   - 將表達式 `x+1` 中的 `x` 替換為 `5`
   - 得到 `5+1 = 6`

2. `(\x.2*x)` 應用於 3：
   - 將表達式 `2*x` 中的 `x` 替換為 `3`
   - 得到 `2*3 = 6`

3. `(\x.x*x)` 應用於 4：
   - 將表達式 `x*x` 中的 `x` 替換為 `4`
   - 得到 `4*4 = 16`

4. `(\y.(y+1)*2)` 應用於 3：
   - 將表達式 `(y+1)*2` 中的 `y` 替換為 `3`
   - 得到 `(3+1)*2 = 4*2 = 8`
   - 注意：乘法優先於加法，但括號改變了優先順序

5. `(\z.z*(z+1)+(z-1))` 應用於 4：
   - 將表達式 `z*(z+1)+(z-1)` 中的 `z` 替換為 `4`
   - 得到 `4*(4+1)+(4-1) = 4*5+3 = 20+3 = 23`
   - 計算順序：先算括號內的，再按乘法優先於加法的順序

6. `(\a.(a+2)*(a-1)+a*a)` 應用於 2：
   - 將表達式 `(a+2)*(a-1)+a*a` 中的 `a` 替換為 `2`
   - 得到 `(2+2)*(2-1)+2*2 = 4*1+4 = 4+4 = 8`

## 限制條件
- 查詢數量：1 ≤ N ≤ 20
- 變數名稱：小寫字母開頭，可包含數字 (例如：`x`, `y`, `var1`, `param2`)
- 輸入值：0 ≤ value ≤ 100 (非負整數)
- 支援運算：僅限 `+` (加法)、`-` (減法)、`*` (乘法)
- 計算範圍：所有中間和最終結果都能放入 64 位元有符號整數 (`long long`)
- 表達式長度：依測資難度而定，詳見下方測資點說明

---

## 測資點

| 難度等級          | 權重 | 嵌套深度  | 表達式長度   | 時間限制                  |
| ----------------- | ---- | --------- | ------------ | ------------------------- |
| **簡單 (Easy)**   | 30%  | 無嵌套    | ≤ 20 字符    | 所有語言 ≤ 1s             |
| **中等 (Medium)** | 25%  | ≤ 8 層    | ≤ 50 字符    | 所有語言 ≤ 1s             |
| **困難 (Hard)**   | 25%  | ≤ 32 層   | ≤ 200 字符   | C/C++ ≤ 1s<br>Python ≤ 3s |
| **地獄 (Hell)**   | 20%  | ≤ 1024 層 | ≤ 12000 字符 | C/C++ ≤ 1s<br>Python ≤ 5s |

### 特別注意事項
- **Python 遞迴限制**: 地獄級測資可能需要調整 `sys.setrecursionlimit(2000)` 或更高
- **記憶體使用**: 深層嵌套可能導致堆疊溢位，建議使用迭代方法或最佳化遞迴


### 關鍵實作要點

- 1. 正確處理嵌套括號
- 2. 變數作用域管理
  - Lambda 變數會遮蔽 (shadow) 外層同名變數
  - 使用變數堆疊或環境表來追蹤作用域
  - 在變數替換時要小心處理嵌套的 lambda
- 3. 遞迴深度優化
  - **地獄級測資**: 深度可達 1024，需特別處理
  - **Python**: 使用 `sys.setrecursionlimit(2000)` 增加遞迴限制
  - **C++**: 考慮使用迭代方式或增加堆疊大小
  - **替代方案**: 使用顯式堆疊模擬遞迴


### 常見錯誤與除錯

#### 語法錯誤
- ❌ 忘記處理負數（如 `-5`）
- ❌ 運算子優先順序錯誤：`2+3*4` 應該是 `14` 不是 `20`
- ❌ 括號配對錯誤：未正確匹配開閉括號

#### 語意錯誤
- ❌ 變數替換時的作用域錯誤
- ❌ 變數名稱不匹配：區分大小寫
- ❌ 算術溢出：中間結果超出整數範圍

#### 效能問題
- ❌ 遞迴深度太深（特別是 Python）

